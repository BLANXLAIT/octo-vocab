name: Test Authentication

on:
  # Manual trigger for testing
  workflow_dispatch:
  
  # Run on changes to deployment files  
  push:
    paths:
      - '.github/workflows/ios-deploy.yml'
      - 'ios/fastlane/**'

env:
  FLUTTER_VERSION: '3.35.0'
  FLUTTER_CHANNEL: 'stable'

jobs:
  test_auth:
    runs-on: macos-15
    timeout-minutes: 10
    name: 🔐 Test Authentication
    
    steps:
    - name: 📱 Checkout repository
      uses: actions/checkout@v4

    - name: 💎 Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: 🚀 Install Fastlane
      run: |
        gem install fastlane
        fastlane --version

    - name: 🔐 Configure App Store Connect API
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        MATCH_CERTS_PAT: ${{ secrets.MATCH_CERTS_PAT }}
      run: |
        # Export environment variables for fastlane
        echo "APP_STORE_CONNECT_API_KEY_ID=$APP_STORE_CONNECT_API_KEY_ID" >> $GITHUB_ENV
        echo "APP_STORE_CONNECT_ISSUER_ID=$APP_STORE_CONNECT_ISSUER_ID" >> $GITHUB_ENV
        echo "FASTLANE_TEAM_ID=$FASTLANE_TEAM_ID" >> $GITHUB_ENV
        echo "MATCH_PASSWORD=$MATCH_PASSWORD" >> $GITHUB_ENV
        echo "MATCH_GIT_URL=$MATCH_GIT_URL" >> $GITHUB_ENV
        echo "MATCH_CERTS_PAT=$MATCH_CERTS_PAT" >> $GITHUB_ENV
        
        # Export API key content as multiline environment variable
        echo "APP_STORE_CONNECT_API_KEY_CONTENT<<EOF" >> $GITHUB_ENV
        echo "$APP_STORE_CONNECT_API_KEY_CONTENT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: 🧪 Test App Store Connect API Authentication
      working-directory: ios
      run: |
        echo "🔍 Testing App Store Connect API authentication..."
        echo "This test must succeed for deployment to work properly."
        fastlane test_auth

    - name: 🔐 Test Match Certificate Access (Read-Only)
      working-directory: ios
      run: |
        echo "🔍 Testing Match certificate repository access (read-only)..."
        
        # Configure Git credentials for private repository access
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Test basic Match access (readonly mode to avoid making changes)
        MATCH_READONLY=true fastlane sync_certificates
        
    - name: 🔐 Test Match Certificate Validation (API Required)
      working-directory: ios
      run: |
        echo "🔍 Testing Match certificate validation with Apple API..."
        echo "This validates that certificates are still valid on Apple's servers."
        
        # Test non-readonly mode which requires Apple API validation
        # This is the same test that the actual deployment uses
        fastlane sync_certificates

    - name: ✅ Authentication Summary  
      if: always()
      run: |
        echo "## 🔐 Authentication Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Components:" >> $GITHUB_STEP_SUMMARY
        echo "1. **App Store Connect API Authentication**: Direct API key validation" >> $GITHUB_STEP_SUMMARY
        echo "2. **Match Certificate Repository**: GitHub PAT access test" >> $GITHUB_STEP_SUMMARY
        echo "3. **Match Certificate Apple Validation**: Apple API certificate validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Overall Result:" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" = "success" ]; then
          echo "🎉 **All authentication tests passed!** ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**✅ Ready for iOS deployment**" >> $GITHUB_STEP_SUMMARY
          echo "- App Store Connect API key is valid and working" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub PAT has proper repository access" >> $GITHUB_STEP_SUMMARY
          echo "- Apple certificate validation is working" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Authentication issues detected** ❌" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**🚨 NOT ready for deployment**" >> $GITHUB_STEP_SUMMARY
          echo "- Check App Store Connect API key validity and expiration" >> $GITHUB_STEP_SUMMARY
          echo "- Verify GitHub PAT has repository access permissions" >> $GITHUB_STEP_SUMMARY
          echo "- Confirm all organization secrets are properly configured" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- **If successful**: Safe to run iOS deployment workflow" >> $GITHUB_STEP_SUMMARY
        echo "- **If failed**: Fix authentication issues before deploying" >> $GITHUB_STEP_SUMMARY